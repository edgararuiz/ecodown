---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(fs)

cat_tree <- function(x, ...) {
  t <-  capture.output(dir_tree(x, ... = ...))
  t[[2]] <- paste0(" ", t[[2]])
  cat(purrr::map_chr(t[2:length(t)], ~ paste0(.x, "\n")))  
}

temp_dir <- tempdir()
dir_site <- path(temp_dir, "test_site")
if(dir_exists(path(temp_dir, "mleap"))) dir_delete(path(temp_dir, "mleap"))
if(dir_exists(dir_site)) dir_delete(dir_site)
```

# ecodown

<!-- badges: start -->
[![Codecov test coverage](https://codecov.io/gh/edgararuiz/ecodown/branch/main/graph/badge.svg)](https://app.codecov.io/gh/edgararuiz/ecodown?branch=main)
[![R-CMD-check](https://github.com/edgararuiz/ecodown/workflows/R-CMD-check/badge.svg)](https://github.com/edgararuiz/ecodown/actions)
<!-- badges: end -->

The goal of `ecodown` is to make it possible for your R package's documentation to
be published in a Quarto site.  

The vision for `ecodown` is that it is used to document a group of related packages
that will be published to a single Quarto site.  

## Installation

You can install the development version of `ecodown` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("edgararuiz/ecodown")
```

## Using 

There are 5 steps needed in order to keep the package's documentation updated in a
Quarto site:

1. [Download the latest package source](#download-the-latest-package-source)
1. [Prepare the documentation for Quarto](#prepare-the-documentation-for-quarto)
1. [Run Quarto locally](#run-quarto-locally)
1. [Run auto-linking](#run-auto-linking)
1. Commit the changes back to the site


```{r}
library(ecodown)
```
 
### Download the latest package source

The assumption is that the Git repository of the package is different from that
of the Quarto site.  Again, the idea is that the Quarto site is being used to
document multiple packages.

This means that the package's source will be external to the Quarto-site repository,
so it is likely that the latest bits will have to be cloned from Git.  

`ecodown` uses the package's source to produce the documentation. Use 
`package_clone_git_repo()` to download the the package.  By default, it clones 
the repo to a temp directory. We will use the `mleap` package for this example:
 
```{r}
mleap_location <- package_clone_git_repo("https://github.com/rstudio/mleap")
```

This is not a required step, only use if the latest source is not available in your
laptop, or if you are using `ecodown` as part of your CI/CD automation.

Here are the current contents of the package:

```{r, echo = FALSE}
cat_tree(mleap_location, recurse = FALSE)
```

And the contents of the 'man' folder: 

```{r, echo = FALSE}
cat_tree(path(mleap_location, "man"))
```

### Prepare the documentation for Quarto

`package_build_documentation()` is the main function out of `ecodown`. It is 
similar to the `pkgdown`'s `build_site()`.  It will map and copy the README, 
NEWS and vignettes files. It will also parse and convert the '.Rd' files into 
'.Md' files.  

The `project_folder` creates a sub-folder in your workspace where the documentation
is going to be converted and copied to.

```{r, eval = FALSE}
package_build_documentation(
  pkg_folder = mleap_location,
  project_folder = "mleap"
)
```

```{r, echo = FALSE}
temp_dir <- tempdir()

package_build_documentation(
  pkg_folder = mleap_location,
  root_folder = dir_site,
  project_folder = "mleap"
)
```

```{r, include = FALSE}
quarto_folder <- system.file("testutils/quarto_files", package = "ecodown")
lapply(dir_ls(quarto_folder), function(x) file_copy(x, dir_site))
```

## Run Quarto locally

```{r, eval = FALSE}
quarto::quarto_serve()
```

```{r, include = FALSE}
quarto::quarto_serve(dir = dir_site)
```


```{r, echo = FALSE}
cat_tree(path(dir_site, "docs"))
```

## Run auto-linking

```{r, include = FALSE}
site_autolink_html(path(dir_site, "docs"))
```

```{r}
site_autolink_html(path(dir_site, "docs"))
```


